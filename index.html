<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Tasks</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .high { color: red; }
        .medium { color: orange; }
        .low { color: green; }
        .due-soon { background-color: #fff3cd; }
        .overdue { background-color: #f8d7da; }
        .completed { text-decoration: line-through; color: gray; }
    </style>
</head>
<body class="container py-4">
    <h2>Welcome, {{ session.username }}</h2>
    <a href="/logout" class="btn btn-danger btn-sm float-end">Logout</a>
    <a href="/summary" class="btn btn-info btn-sm float-end me-2">Weekly Summary</a>

    <h3 class="mt-4">Add New Task</h3>
    <form method="POST" action="/add" class="row g-2 mb-4">
        <div class="col-md-4">
            <input type="text" name="task" class="form-control" placeholder="Enter task..." required>
        </div>
        <div class="col-md-2">
            <select name="priority" class="form-select">
                <option value="High">High</option>
                <option value="Medium" selected>Medium</option>
                <option value="Low">Low</option>
            </select>
        </div>
        <div class="col-md-2">
            <select name="category" class="form-select">
                <option value="Work">Work</option>
                <option value="Personal">Personal</option>
                <option value="Other" selected>Other</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="date" name="due_date" class="form-control" required>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Add Task</button>
        </div>
    </form>

    <h3>Your Tasks</h3>
    <ul class="list-group">
        {% for task in tasks %}
            {% set due_date = task.get('due_date') %}
            {% set priority = task.get('priority', 'Medium') %}
            {% set completed = task.get('completed') %}
            {% set category = task.get('category', 'Other') %}
            {% set css_class = '' %}
            {% if completed %}{% set css_class = css_class + ' completed' %}{% endif %}

            {% if due_date %}
                {% set due_obj = due_date | todatetime %}
                {% if due_obj.date() < now.date() %}
                    {% set css_class = css_class + ' overdue' %}
                {% elif (due_obj.date() - now.date()).days <= 2 %}
                    {% set css_class = css_class + ' due-soon' %}
                {% endif %}
            {% endif %}

            <li class="list-group-item {{ css_class }}">
                <strong>[{{ category }}]</strong>
                <span class="{{ priority | lower }}">{{ task['task'] }}</span>
                {% if due_date %}
                    <small>(Due: {{ due_obj.strftime('%d %b, %Y') }})</small>
                {% endif %}
                <form action="/toggle/{{ task['_id'] }}" method="POST" class="d-inline">
                    <button class="btn btn-sm btn-secondary">Toggle</button>
                </form>
                <form action="/delete/{{ task['_id'] }}" method="POST" class="d-inline">
                    <button class="btn btn-sm btn-danger">Delete</button>
                </form>
                <a href="/task/{{ task['_id'] }}" class="btn btn-sm btn-outline-info">View</a>
            </li>
        {% endfor %}
    </ul>
</body>
</html>
